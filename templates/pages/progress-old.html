{% extends "base.html" %}

{% block content %}
<div class="max-w-4xl mx-auto px-6 py-8" x-data="progressTracker()">
    <!-- Header -->
    <div class="text-center mb-12">
        <span class="text-5xl mb-4 block">üìä</span>
        <h1 class="text-3xl font-bold text-white mb-2">My Progress</h1>
        <p class="text-slate-400">Track your learning journey across all modules</p>
    </div>
    
    <!-- Overall Progress Card -->
    <div class="bg-gradient-to-r from-primary-500/20 to-accent-500/20 border border-primary-500/30 rounded-xl p-6 mb-8">
        <div class="flex items-center justify-between mb-4">
            <div>
                <h2 class="text-xl font-semibold text-white">Overall Progress</h2>
                <p class="text-sm text-slate-400">Keep going, you're doing great!</p>
            </div>
            <div class="text-right">
                <div class="text-4xl font-bold text-white" x-text="overallProgress + '%'">0%</div>
                <div class="text-sm text-slate-400" x-text="completedItems + ' / ' + totalItems + ' items'">0 items</div>
            </div>
        </div>
        <div class="w-full h-4 bg-slate-700 rounded-full overflow-hidden">
            <div class="h-full bg-gradient-to-r from-primary-500 to-accent-500 transition-all duration-500" 
                 :style="'width: ' + overallProgress + '%'"></div>
        </div>
    </div>
    
    <!-- Stats Grid -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
        <div class="bg-slate-800 border border-slate-700 rounded-lg p-4 text-center">
            <div class="text-3xl font-bold text-green-400" x-text="completedLessons">0</div>
            <div class="text-sm text-slate-400">Lessons</div>
        </div>
        <div class="bg-slate-800 border border-slate-700 rounded-lg p-4 text-center">
            <div class="text-3xl font-bold text-amber-400" x-text="completedLabs">0</div>
            <div class="text-sm text-slate-400">Labs</div>
        </div>
        <div class="bg-slate-800 border border-slate-700 rounded-lg p-4 text-center">
            <div class="text-3xl font-bold text-purple-400" x-text="completedQuizzes">0</div>
            <div class="text-sm text-slate-400">Quizzes</div>
        </div>
        <div class="bg-slate-800 border border-slate-700 rounded-lg p-4 text-center">
            <div class="text-3xl font-bold text-blue-400" x-text="streak">0</div>
            <div class="text-sm text-slate-400">Day Streak</div>
        </div>
    </div>
    
    <!-- Achievement Badges -->
    <div class="bg-slate-800 border border-slate-700 rounded-xl p-6 mb-8">
        <h2 class="text-lg font-semibold text-white mb-4">üèÜ Achievements</h2>
        <div class="grid grid-cols-3 md:grid-cols-6 gap-4">
            <div class="text-center" :class="{ 'opacity-30': !badges.firstLesson }">
                <div class="w-12 h-12 mx-auto mb-2 rounded-full bg-green-500/20 flex items-center justify-center text-2xl">
                    üìñ
                </div>
                <div class="text-xs text-slate-400">First Lesson</div>
            </div>
            <div class="text-center" :class="{ 'opacity-30': !badges.firstLab }">
                <div class="w-12 h-12 mx-auto mb-2 rounded-full bg-amber-500/20 flex items-center justify-center text-2xl">
                    üß™
                </div>
                <div class="text-xs text-slate-400">First Lab</div>
            </div>
            <div class="text-center" :class="{ 'opacity-30': !badges.firstQuiz }">
                <div class="w-12 h-12 mx-auto mb-2 rounded-full bg-purple-500/20 flex items-center justify-center text-2xl">
                    üìù
                </div>
                <div class="text-xs text-slate-400">Quiz Master</div>
            </div>
            <div class="text-center" :class="{ 'opacity-30': !badges.weekStreak }">
                <div class="w-12 h-12 mx-auto mb-2 rounded-full bg-red-500/20 flex items-center justify-center text-2xl">
                    üî•
                </div>
                <div class="text-xs text-slate-400">7 Day Streak</div>
            </div>
            <div class="text-center" :class="{ 'opacity-30': !badges.moduleComplete }">
                <div class="w-12 h-12 mx-auto mb-2 rounded-full bg-blue-500/20 flex items-center justify-center text-2xl">
                    üéì
                </div>
                <div class="text-xs text-slate-400">Module Done</div>
            </div>
            <div class="text-center" :class="{ 'opacity-30': !badges.allComplete }">
                <div class="w-12 h-12 mx-auto mb-2 rounded-full bg-primary-500/20 flex items-center justify-center text-2xl">
                    üèÜ
                </div>
                <div class="text-xs text-slate-400">Complete!</div>
            </div>
        </div>
    </div>
    
    <!-- Module Progress -->
    <div class="space-y-4">
        <h2 class="text-lg font-semibold text-white">Module Progress</h2>
        
        {% for module in all_modules %}
        <div class="bg-slate-800 border border-slate-700 rounded-lg p-4" 
             x-data="{ 
                progress: 0,
                init() {
                    // Calculate progress for this module
                    let completed = 0;
                    let total = {{ module.total_items }};
                    {% for section in module.sections %}
                    {% for page in section.pages %}
                    if (localStorage.getItem('completed_{{ page.id }}') === 'true') completed++;
                    {% endfor %}
                    {% for lab in section.labs %}
                    if (localStorage.getItem('completed_{{ lab.id }}') === 'true') completed++;
                    {% endfor %}
                    {% for quiz in section.quizzes %}
                    if (localStorage.getItem('completed_{{ quiz.id }}') === 'true') completed++;
                    {% endfor %}
                    {% endfor %}
                    this.progress = total > 0 ? Math.round((completed / total) * 100) : 0;
                }
             }">
            <div class="flex items-center justify-between mb-3">
                <div class="flex items-center space-x-3">
                    <span class="text-2xl">{{ module.icon }}</span>
                    <div>
                        <a href="/learn/{{ module.id }}" class="font-medium text-white hover:text-primary-400 transition-colors">
                            {{ module.title }}
                        </a>
                        <div class="text-sm text-slate-500">{{ module.sections|length }} sections ¬∑ {{ module.total_items }} items</div>
                    </div>
                </div>
                <div class="text-right">
                    <div class="font-medium text-white" x-text="progress + '%'">0%</div>
                </div>
            </div>
            <div class="w-full h-2 bg-slate-700 rounded-full overflow-hidden">
                <div class="h-full bg-primary-500 transition-all duration-500" :style="'width: ' + progress + '%'"></div>
            </div>
        </div>
        {% endfor %}
    </div>
    
    <!-- Reset Progress -->
    <div class="mt-8 text-center">
        <button @click="if(confirm('Are you sure you want to reset all progress? This cannot be undone.')) resetProgress()"
                class="text-sm text-red-400 hover:text-red-300 transition-colors">
            Reset All Progress
        </button>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function progressTracker() {
    return {
        completedLessons: 0,
        completedLabs: 0,
        completedQuizzes: 0,
        completedItems: 0,
        totalItems: 0,
        overallProgress: 0,
        streak: 0,
        badges: {
            firstLesson: false,
            firstLab: false,
            firstQuiz: false,
            weekStreak: false,
            moduleComplete: false,
            allComplete: false
        },
        
        init() {
            this.calculateProgress();
            this.calculateStreak();
            this.checkBadges();
        },
        
        calculateProgress() {
            // Count all completed items from localStorage
            let lessons = 0, labs = 0, quizzes = 0;
            
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith('completed_') && localStorage.getItem(key) === 'true') {
                    // Categorize by type (simplified - in production, use registry data)
                    if (key.includes('lab') || key.includes('Lab')) {
                        labs++;
                    } else if (key.includes('quiz') || key.includes('Quiz')) {
                        quizzes++;
                    } else {
                        lessons++;
                    }
                }
            }
            
            this.completedLessons = lessons;
            this.completedLabs = labs;
            this.completedQuizzes = quizzes;
            this.completedItems = lessons + labs + quizzes;
            
            // Calculate total from registry (placeholder - would be dynamic)
            this.totalItems = {{ all_modules|sum(attribute='total_items') if all_modules else 50 }};
            this.overallProgress = this.totalItems > 0 ? Math.round((this.completedItems / this.totalItems) * 100) : 0;
        },
        
        calculateStreak() {
            // Get learning dates from localStorage
            const today = new Date().toDateString();
            const lastLearned = localStorage.getItem('last_learned_date');
            let currentStreak = parseInt(localStorage.getItem('learning_streak') || '0');
            
            if (lastLearned !== today) {
                const lastDate = lastLearned ? new Date(lastLearned) : null;
                const todayDate = new Date(today);
                
                if (lastDate) {
                    const diffDays = Math.floor((todayDate - lastDate) / (1000 * 60 * 60 * 24));
                    if (diffDays === 1) {
                        currentStreak++;
                    } else if (diffDays > 1) {
                        currentStreak = 1;
                    }
                }
            }
            
            this.streak = currentStreak;
        },
        
        checkBadges() {
            this.badges.firstLesson = this.completedLessons > 0;
            this.badges.firstLab = this.completedLabs > 0;
            this.badges.firstQuiz = this.completedQuizzes > 0;
            this.badges.weekStreak = this.streak >= 7;
            this.badges.moduleComplete = this.overallProgress >= (100 / {{ all_modules|length if all_modules else 9 }});
            this.badges.allComplete = this.overallProgress === 100;
        },
        
        resetProgress() {
            // Clear all completion data
            const keysToRemove = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith('completed_') || key.startsWith('progress_') || key.startsWith('path_')) {
                    keysToRemove.push(key);
                }
            }
            keysToRemove.forEach(key => localStorage.removeItem(key));
            localStorage.removeItem('learning_streak');
            localStorage.removeItem('last_learned_date');
            
            // Refresh the page
            window.location.reload();
        }
    };
}
</script>
{% endblock %}
