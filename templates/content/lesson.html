{% extends "base.html" %}

{% block head %}
<style>
    /* Markdown content styling */
    .prose {
        color: #e2e8f0;
        line-height: 1.75;
    }
    .prose h1 { font-size: 2rem; font-weight: 700; margin-top: 2rem; margin-bottom: 1rem; color: #fff; }
    .prose h2 { font-size: 1.5rem; font-weight: 600; margin-top: 1.5rem; margin-bottom: 0.75rem; color: #fff; border-bottom: 1px solid #334155; padding-bottom: 0.5rem; }
    .prose h3 { font-size: 1.25rem; font-weight: 600; margin-top: 1.25rem; margin-bottom: 0.5rem; color: #fff; }
    .prose p { margin-bottom: 1rem; }
    .prose ul, .prose ol { margin-bottom: 1rem; padding-left: 1.5rem; }
    .prose li { margin-bottom: 0.25rem; }
    .prose ul { list-style-type: disc; }
    .prose ol { list-style-type: decimal; }
    .prose a { color: #38bdf8; text-decoration: underline; }
    .prose a:hover { color: #7dd3fc; }
    .prose blockquote { border-left: 4px solid #38bdf8; padding-left: 1rem; margin: 1rem 0; color: #94a3b8; font-style: italic; }
    .prose strong { color: #fff; font-weight: 600; }
    .prose code:not(.hljs) { background: #1e293b; padding: 0.125rem 0.375rem; border-radius: 0.25rem; font-size: 0.875rem; color: #f472b6; }
    .prose pre { margin: 1rem 0; border-radius: 0.5rem; overflow: hidden; }
    .prose img { max-width: 100%; border-radius: 0.5rem; margin: 1rem 0; }
    .prose table { width: 100%; border-collapse: collapse; margin: 1rem 0; }
    .prose th, .prose td { border: 1px solid #334155; padding: 0.5rem 1rem; text-align: left; }
    .prose th { background: #1e293b; font-weight: 600; }
    
    /* Code block with copy button styling from renderer */
    {{ renderer.get_css() if renderer else '' }}
</style>
{% endblock %}

{% block content %}
<div class="flex">
    <!-- Main Content Area -->
    <div class="flex-1 max-w-4xl mx-auto px-6 py-8">
        <!-- Section Header (if showing section, not page) -->
        {% if section and not page %}
        <div class="mb-8">
            <div class="flex items-center space-x-3 mb-2">
                <span class="text-3xl">{{ section.icon }}</span>
                <h1 class="text-3xl font-bold text-white">{{ section.title }}</h1>
            </div>
            <p class="text-slate-400">{{ section.description }}</p>
            
            <!-- Section Stats -->
            <div class="flex items-center space-x-4 mt-4 text-sm text-slate-500">
                <span>üìñ {{ section.pages|length }} lessons</span>
                {% if section.labs %}<span>üß™ {{ section.labs|length }} labs</span>{% endif %}
                {% if section.quizzes %}<span>üìù {{ section.quizzes|length }} quizzes</span>{% endif %}
                <span>‚è±Ô∏è {{ section.total_time }} min total</span>
            </div>
        </div>
        
        <!-- Section Content List -->
        <div class="space-y-3">
            <h2 class="text-xl font-semibold text-white">Lessons</h2>
            {% for p in section.pages %}
            <a href="/learn/{{ module.id }}/{{ section.id }}/{{ p.id }}" 
               class="block bg-slate-800 border border-slate-700 rounded-lg p-4 hover:border-primary-500/50 transition-colors group"
               x-data="{ completed: false }"
               x-init="completed = ProgressTracker.isComplete('{{ p.id }}')">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                        <span class="w-8 h-8 flex items-center justify-center rounded-full bg-slate-700 text-sm transition-colors"
                              :class="{ 'bg-green-500 text-white': completed }">
                            <span x-show="!completed">{{ loop.index }}</span>
                            <span x-show="completed">‚úì</span>
                        </span>
                        <div>
                            <div class="text-white group-hover:text-primary-400 transition-colors">{{ p.title }}</div>
                            <div class="text-sm text-slate-500">{{ p.description|truncate(80) }}</div>
                        </div>
                    </div>
                    <span class="text-sm text-slate-500">{{ p.estimated_time }} min</span>
                </div>
            </a>
            {% endfor %}
            
            {% if section.labs %}
            <h2 class="text-xl font-semibold text-white mt-8">Labs</h2>
            {% for lab in section.labs %}
            <a href="/learn/{{ module.id }}/{{ section.id }}/{{ lab.id }}" 
               class="block bg-slate-800 border border-amber-500/30 rounded-lg p-4 hover:border-amber-500/50 transition-colors group">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                        <span class="text-2xl">üß™</span>
                        <div>
                            <div class="text-white group-hover:text-amber-400 transition-colors">{{ lab.title }}</div>
                            <div class="text-sm text-slate-500">{{ lab.description|truncate(80) }}</div>
                        </div>
                    </div>
                    <span class="px-2 py-1 bg-amber-500/20 text-amber-400 text-xs rounded">Interactive</span>
                </div>
            </a>
            {% endfor %}
            {% endif %}
            
            {% if section.quizzes %}
            <h2 class="text-xl font-semibold text-white mt-8">Quiz</h2>
            {% for quiz in section.quizzes %}
            <a href="/learn/{{ module.id }}/{{ section.id }}/{{ quiz.id }}" 
               class="block bg-slate-800 border border-purple-500/30 rounded-lg p-4 hover:border-purple-500/50 transition-colors group">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                        <span class="text-2xl">üìù</span>
                        <div>
                            <div class="text-white group-hover:text-purple-400 transition-colors">{{ quiz.title }}</div>
                            <div class="text-sm text-slate-500">{{ quiz.description }}</div>
                        </div>
                    </div>
                    <span class="px-2 py-1 bg-purple-500/20 text-purple-400 text-xs rounded">Pass: {{ quiz.passing_score }}%</span>
                </div>
            </a>
            {% endfor %}
            {% endif %}
        </div>
        
        {% else %}
        <!-- Page Content (lesson, lab, quiz) -->
        <div class="mb-6">
            {% if page %}
            <div class="flex items-center space-x-2 text-sm text-slate-500 mb-4">
                <span>{{ module.icon }} {{ module.title }}</span>
                <span>/</span>
                <span>{{ section.title }}</span>
            </div>
            <h1 class="text-3xl font-bold text-white mb-2">{{ page.title }}</h1>
            <div class="flex items-center space-x-4 text-sm text-slate-400">
                <span>‚è±Ô∏è {{ page.estimated_time }} min read</span>
                {% if page.tags %}
                <div class="flex items-center space-x-2">
                    {% for tag in page.tags[:3] %}
                    <span class="px-2 py-0.5 bg-slate-700 rounded text-xs">{{ tag }}</span>
                    {% endfor %}
                </div>
                {% endif %}
            </div>
            {% endif %}
        </div>
        
        <!-- Rendered Markdown Content -->
        {% if rendered_content %}
        <div class="prose">
            {{ rendered_content | safe }}
        </div>
        {% else %}
        <!-- Placeholder when no content file exists -->
        <div class="bg-slate-800 border border-slate-700 rounded-lg p-8 text-center">
            <span class="text-4xl mb-4 block">üìù</span>
            <h3 class="text-xl font-semibold text-white mb-2">Content Coming Soon</h3>
            <p class="text-slate-400">
                This lesson is being written. Check back soon for updates!
            </p>
        </div>
        {% endif %}
        
        <!-- Navigation -->
        <div class="flex items-center justify-between mt-12 pt-6 border-t border-slate-700">
            {% if prev_content %}
            <a href="/learn/{{ prev_content.module.id }}/{{ prev_content.section.id }}/{{ prev_content.id }}{% if current_path %}?path={{ current_path }}{% endif %}" 
               class="flex items-center space-x-3 text-slate-400 hover:text-white transition-colors group max-w-[45%]">
                <svg class="w-5 h-5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                </svg>
                <div class="min-w-0">
                    <div class="text-xs text-slate-500">Previous {% if prev_content.type == 'lab' %}Lab{% elif prev_content.type == 'quiz' %}Quiz{% else %}Lesson{% endif %}</div>
                    <div class="truncate group-hover:text-primary-400">{{ prev_content.item.title }}</div>
                </div>
            </a>
            {% else %}
            <div></div>
            {% endif %}
            
            {% if next_content %}
            <a href="/learn/{{ next_content.module.id }}/{{ next_content.section.id }}/{{ next_content.id }}{% if current_path %}?path={{ current_path }}{% endif %}" 
               class="flex items-center space-x-3 text-slate-400 hover:text-white transition-colors text-right group max-w-[45%]">
                <div class="min-w-0">
                    <div class="text-xs text-slate-500">Next {% if next_content.type == 'lab' %}Lab{% elif next_content.type == 'quiz' %}Quiz{% else %}Lesson{% endif %}</div>
                    <div class="truncate group-hover:text-primary-400">{{ next_content.item.title }}</div>
                </div>
                <svg class="w-5 h-5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                </svg>
            </a>
            {% elif not next_content and module %}
            <!-- Module/Path complete message -->
            <div class="text-right">
                {% if path_info and path_info.is_last_in_path %}
                <div class="text-xs text-green-500">üéâ Path Complete!</div>
                <a href="/path/{{ current_path }}" class="text-primary-400 hover:text-primary-300">Back to {{ path_info.path_title }}</a>
                {% else %}
                <div class="text-xs text-green-500">üéâ Module Complete!</div>
                <a href="/learn/{{ module.id }}" class="text-primary-400 hover:text-primary-300">Back to {{ module.title }}</a>
                {% endif %}
            </div>
            {% endif %}
        </div>
        
        <!-- Path Progress Indicator (shown when in a learning path) -->
        {% if path_info %}
        <div class="mt-6 p-4 bg-slate-800/50 border border-slate-700 rounded-lg">
            <div class="flex items-center justify-between text-sm mb-2">
                <div class="flex items-center space-x-2">
                    <span>{{ path_info.path_icon }}</span>
                    <a href="/path/{{ current_path }}" class="text-slate-300 hover:text-primary-400 transition-colors">
                        {{ path_info.path_title }}
                    </a>
                </div>
                <span class="text-slate-400">
                    {{ path_info.current_item_index + 1 }} of {{ path_info.total_items }}
                </span>
            </div>
            <div class="w-full h-2 bg-slate-700 rounded-full overflow-hidden">
                <div class="h-full bg-primary-500 transition-all duration-300" 
                     style="width: {{ ((path_info.current_item_index + 1) / path_info.total_items * 100)|round }}%"></div>
            </div>
        </div>
        {% endif %}
        
        <!-- Mark as Complete Button -->
        {% if page %}
        <div class="mt-8 text-center" 
             x-data="{ 
                completed: false,
                bookmarked: false,
                init() {
                    this.completed = ProgressTracker.isComplete('{{ page.id }}');
                    this.bookmarked = ProgressTracker.isBookmarked('{{ page.id }}');
                }
             }">
            <div class="flex items-center justify-center space-x-4">
                <!-- Mark Complete Button -->
                <button @click="
                    if (!completed) {
                        ProgressTracker.markComplete('{{ page.id }}', '{{ page.type if page.type else 'lesson' }}', '{{ module.id }}');
                    } else {
                        ProgressTracker.markIncomplete('{{ page.id }}');
                    }
                    completed = !completed;
                "
                        class="px-6 py-3 rounded-lg font-medium transition-all duration-300"
                        :class="completed ? 'bg-green-500 text-white shadow-lg shadow-green-500/25' : 'bg-slate-700 text-slate-300 hover:bg-slate-600'">
                    <span x-show="!completed">‚úì Mark as Complete</span>
                    <span x-show="completed">‚úì Completed!</span>
                </button>
                
                <!-- Bookmark Button -->
                <button @click="
                    if (bookmarked) {
                        ProgressTracker.removeBookmark('{{ page.id }}');
                    } else {
                        ProgressTracker.addBookmark('{{ page.id }}', '{{ page.title }}', '{{ module.id }}');
                    }
                    bookmarked = !bookmarked;
                "
                        class="p-3 rounded-lg transition-all duration-300"
                        :class="bookmarked ? 'bg-amber-500 text-white' : 'bg-slate-700 text-slate-400 hover:bg-slate-600 hover:text-white'"
                        title="Bookmark this page">
                    <span x-show="!bookmarked">üîñ</span>
                    <span x-show="bookmarked">üìë</span>
                </button>
            </div>
            
            <!-- Completion timestamp -->
            <p x-show="completed" class="text-sm text-green-400/70 mt-2">
                Great progress! Keep going! üéâ
            </p>
        </div>
        {% endif %}
        {% endif %}
    </div>
    
    <!-- Right Sidebar - Table of Contents -->
    <aside class="hidden xl:block w-64 flex-shrink-0 p-6 border-l border-slate-700">
        <div class="sticky top-6">
            <h3 class="text-sm font-semibold text-white mb-4">On this page</h3>
            <nav id="toc" class="space-y-2 text-sm">
                <!-- Will be populated by JavaScript -->
            </nav>
            
            {% if section and section.labs %}
            <div class="mt-8">
                <h3 class="text-sm font-semibold text-white mb-4">Related Labs</h3>
                <div class="space-y-2">
                    {% for lab in section.labs %}
                    <a href="/learn/{{ module.id }}/{{ section.id }}/{{ lab.id }}" 
                       class="block text-sm text-slate-400 hover:text-amber-400 transition-colors">
                        üß™ {{ lab.title }}
                    </a>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>
    </aside>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Generate Table of Contents from headings
    document.addEventListener('DOMContentLoaded', function() {
        const prose = document.querySelector('.prose');
        const toc = document.getElementById('toc');
        
        if (prose && toc) {
            const headings = prose.querySelectorAll('h2, h3');
            headings.forEach((heading, index) => {
                // Add ID if not present
                if (!heading.id) {
                    heading.id = 'heading-' + index;
                }
                
                const link = document.createElement('a');
                link.href = '#' + heading.id;
                link.textContent = heading.textContent;
                link.className = heading.tagName === 'H2' 
                    ? 'block text-slate-400 hover:text-white transition-colors'
                    : 'block pl-3 text-slate-500 hover:text-slate-300 transition-colors';
                toc.appendChild(link);
            });
        }
        
        // Initialize code highlighting
        hljs.highlightAll();
        
        // Add copy buttons to code blocks
        document.querySelectorAll('pre code').forEach((block) => {
            const button = document.createElement('button');
            button.className = 'copy-button absolute top-2 right-2 px-2 py-1 text-xs bg-slate-600 hover:bg-slate-500 rounded text-slate-300';
            button.textContent = 'Copy';
            button.onclick = () => {
                navigator.clipboard.writeText(block.textContent);
                button.textContent = 'Copied!';
                setTimeout(() => { button.textContent = 'Copy'; }, 2000);
            };
            
            const pre = block.parentElement;
            pre.style.position = 'relative';
            pre.appendChild(button);
        });
    });
</script>
{% endblock %}
